#!/bin/bash
# =============================================================================
# Environment Bootstrap Script
# =============================================================================
# This script runs once when `chezmoi apply` is executed on a new machine.
# It installs all required tools to replicate the development environment.
# =============================================================================

set -e  # Exit on error

echo "Starting environment setup..."

# =============================================================================
# Detect OS
# =============================================================================
OS="$(uname -s)"
echo "Detected OS: $OS"

# =============================================================================
# Package Installation (OS-specific)
# =============================================================================
if [ "$OS" = "Darwin" ]; then
    # macOS - use Homebrew
    echo "Installing packages via Homebrew..."

    if ! command -v brew &> /dev/null; then
        echo "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    brew install git zsh fzf neovim tmux ruby node \
        mosh lazygit ripgrep fd bat jq htop gh docker

elif [ "$OS" = "Linux" ]; then
    # Linux - use apt (Ubuntu/Debian)
    echo "Installing packages via apt..."

    sudo apt update
    sudo apt install -y \
        git \
        zsh \
        fzf \
        tmux \
        ruby-full \
        curl \
        build-essential \
        locales \
        mosh \
        ripgrep \
        fd-find \
        bat \
        jq \
        htop \
        ca-certificates \
        gnupg \
        unzip

    # Fix locale
    sudo locale-gen en_US.UTF-8
    sudo update-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

    # Create symlink for bat (Ubuntu installs as batcat)
    if command -v batcat &> /dev/null && ! command -v bat &> /dev/null; then
        sudo ln -sf "$(which batcat)" /usr/local/bin/bat
    fi

    # -------------------------------------------------------------------------
    # Node.js 22 via NodeSource
    # -------------------------------------------------------------------------
    if ! command -v node &> /dev/null; then
        echo "Installing Node.js 22 via NodeSource..."
        curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
        sudo apt install -y nodejs
    fi

    # -------------------------------------------------------------------------
    # Neovim (stable from GitHub release - apt version is too old)
    # -------------------------------------------------------------------------
    if ! command -v nvim &> /dev/null; then
        echo "Installing Neovim from GitHub release..."
        NVIM_VERSION="v0.11.6"
        curl -fsSL "https://github.com/neovim/neovim/releases/download/${NVIM_VERSION}/nvim-linux-x86_64.tar.gz" -o /tmp/nvim.tar.gz
        sudo mkdir -p /opt
        sudo tar -xzf /tmp/nvim.tar.gz -C /opt/
        sudo ln -sf /opt/nvim-linux-x86_64/bin/nvim /usr/local/bin/nvim
        rm /tmp/nvim.tar.gz
    fi

    # -------------------------------------------------------------------------
    # GitHub CLI (gh)
    # -------------------------------------------------------------------------
    if ! command -v gh &> /dev/null; then
        echo "Installing GitHub CLI..."
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg 2>/dev/null
        sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install -y gh
    fi

    # -------------------------------------------------------------------------
    # Google Cloud CLI (gcloud) via apt
    # -------------------------------------------------------------------------
    if ! command -v gcloud &> /dev/null; then
        echo "Installing Google Cloud CLI..."
        curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list > /dev/null
        sudo apt update
        sudo apt install -y google-cloud-sdk
    fi

    # -------------------------------------------------------------------------
    # Docker (official Docker repo)
    # -------------------------------------------------------------------------
    if ! command -v docker &> /dev/null; then
        echo "Installing Docker..."
        sudo install -m 0755 -d /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        sudo chmod a+r /etc/apt/keyrings/docker.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        sudo apt update
        sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
        sudo usermod -aG docker "$(whoami)"
    fi

    # -------------------------------------------------------------------------
    # lazygit (from GitHub release)
    # -------------------------------------------------------------------------
    if ! command -v lazygit &> /dev/null; then
        echo "Installing lazygit..."
        LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
        curl -fsSL "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz" -o /tmp/lazygit.tar.gz
        tar -xzf /tmp/lazygit.tar.gz -C /tmp lazygit
        sudo install /tmp/lazygit /usr/local/bin/lazygit
        rm /tmp/lazygit.tar.gz /tmp/lazygit
    fi
fi

# =============================================================================
# Oh My Zsh
# =============================================================================
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo "Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

# =============================================================================
# Oh My Zsh Custom Plugins
# =============================================================================
ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"

# zsh-syntax-highlighting
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting" ]; then
    echo "Installing zsh-syntax-highlighting..."
    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting"
fi

# zsh-autosuggestions
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-autosuggestions" ]; then
    echo "Installing zsh-autosuggestions..."
    git clone https://github.com/zsh-users/zsh-autosuggestions.git "$ZSH_CUSTOM/plugins/zsh-autosuggestions"
fi

# zsh-bat
if [ ! -d "$ZSH_CUSTOM/plugins/zsh-bat" ]; then
    echo "Installing zsh-bat..."
    git clone https://github.com/fdellwing/zsh-bat.git "$ZSH_CUSTOM/plugins/zsh-bat"
fi

# you-should-use
if [ ! -d "$ZSH_CUSTOM/plugins/you-should-use" ]; then
    echo "Installing you-should-use..."
    git clone https://github.com/MichaelAquilina/zsh-you-should-use.git "$ZSH_CUSTOM/plugins/you-should-use"
fi

# =============================================================================
# Starship Prompt
# =============================================================================
if ! command -v starship &> /dev/null; then
    echo "Installing Starship prompt..."
    curl -sS https://starship.rs/install.sh | sudo sh -s -- -y
fi

# =============================================================================
# Ruby Gems
# =============================================================================
echo "Installing Ruby gems..."
gem install colorls --user-install

# Add gem bin to PATH for this session
export PATH="$(ruby -e 'puts Gem.user_dir')/bin:$PATH"

# =============================================================================
# Tmuxifier
# =============================================================================
if [ ! -d "$HOME/.tmux/plugins/tmuxifier" ]; then
    echo "Installing Tmuxifier..."
    git clone https://github.com/jimeh/tmuxifier.git "$HOME/.tmux/plugins/tmuxifier"
fi

# =============================================================================
# TPM (Tmux Plugin Manager) + install plugins
# =============================================================================
if [ ! -d "$HOME/.tmux/plugins/tpm" ]; then
    echo "Installing TPM (Tmux Plugin Manager)..."
    git clone https://github.com/tmux-plugins/tpm "$HOME/.tmux/plugins/tpm"
fi

# Install tmux plugins via TPM
if [ -x "$HOME/.tmux/plugins/tpm/bin/install_plugins" ]; then
    echo "Installing tmux plugins..."
    "$HOME/.tmux/plugins/tpm/bin/install_plugins"
fi

# =============================================================================
# Claude Code CLI
# =============================================================================
if ! command -v claude &> /dev/null; then
    echo "Installing Claude Code..."
    curl -fsSL https://claude.ai/install.sh | bash
fi

# =============================================================================
# Set Zsh as default shell
# =============================================================================
if [ "$SHELL" != "$(which zsh)" ]; then
    echo "Setting Zsh as default shell..."
    if [ "$OS" = "Linux" ]; then
        sudo chsh -s "$(which zsh)" "$(whoami)"
    else
        chsh -s "$(which zsh)"
    fi
fi

echo ""
echo "Environment setup complete!"
echo "Please restart your shell or run: exec zsh"
echo ""
